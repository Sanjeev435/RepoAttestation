<!DOCTYPE html>
<html lang="en">
<head>
<title>RBS Bitbucket Repo Attestation</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/custom/rbs.css">

<script src="js/bootstrap.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/rbs.js"></script>

<script type="text/javascript">
	
   /**
     * Autocomplete for project dropdown
     */ 
	function getProjectList(inputValue) {
	    // create one global XHR object 
	    // so we can abort old requests when a new one is make
		window.hinterXHR = new XMLHttpRequest();

	    // retrieve the datalist element
	    var projectList = document.getElementById('project_list');

	    // minimum number of characters before we start to generate suggestions
	    var min_characters = 3;

	    if (inputValue.length < min_characters ) { 
	        return;
	    } else {

	        // abort any pending requests
	        window.hinterXHR.abort();

	        window.hinterXHR.onreadystatechange = function() {
	            if (this.readyState === 4 && this.status === 200) {

	                // We're expecting a json response so we convert it to an object
	                var response = JSON.parse( this.responseText ); 

	                // clear any previously loaded options in the datalist
	                projectList.innerHTML = "";

	                response.forEach(function(item) {
	                    // Create a new <option> element.
	                    var option = document.createElement('option');
	                    option.value = item;

	                    // attach the option to the datalist element
	                    projectList.appendChild(option);
	                });
	            } else if(this.readyState === 4 && this.status !== 200) {
	            	alert('Error while getting projects for attestion. Please refresh the page. If problem persist, '
							+ 'please contact support.');
	            }
	        };

	        window.hinterXHR.open("GET", contextUrl + "/projects?query=" + inputValue.toUpperCase(), true);
	        window.hinterXHR.send();
	    }
	}
	
   /**
     * Get repository url for the selected project name and set it in repository input box
     */ 
	function updateRepositoryUrl(projectName) {
		if (projectName !== '') {
			$.ajax({
				url : contextUrl + "/project",
				type : "get", //send it through get method
				data : {
					"projectName" : projectName
				},
				dataType : 'json',
				success : function(response) {
					if(response['projectId'] === 0){
						alert('Please select a valid project from project dropdown');
					}else{
						$('input[name=repositoryUrl]').val(
								response['repositoryUrl']);
						$('input[name=projectId]').val(response['projectId']);
					}
				},
				error : function(xhr) {
					console.log(xhr);
					alert('Error while getting project reporitory URL. Please re-try. If problem persist, '
							+ 'please contact support.');
				}
			});
		}
	};

   /**
     * Submit attestation data
     */ 
	function submitAttestation() {
		var formData = $('form').serialize();
		
		if(isFieldsValidated()){
			$.ajax({
				url : contextUrl + "/save",
				type : "post", //send it through post method
				data : formData,
				dataType : 'text',
				success : function(response) {
					alert('Attestion has been successfully saved !!');
					$('#attestation').trigger("reset");
				},
				error : function(err) {
					console.log("Error while saving attestation data !!", err);
					alert('Error while saving attestion data. Please re-try. If problem persist, '
							+ 'please contact support.');
				}
			});
		}
	}
	
   /**
     * Check if all mandatory fields filled, show alert in case if missed any
     */ 
	function isFieldsValidated() {
		var isValidated = true;
		var validationMessage = '';

		if ($("#empId").val() === '') {
			isValidated = false;
			validationMessage += 'RBS Id is mandatory.\n';
		}

		if ($("#email").val() === '') {
			isValidated = false;
			validationMessage += 'Email is mandatory.\n';
		}
		
		if ($("#projectId").val() === '') {
			isValidated = false;
			validationMessage += 'Please select a project. \n';
		}

		if ($("#confirmed").is(":checked") === false) {
			isValidated = false;
			validationMessage += 'Please accept the attestation terms.\n';
		}

		if (!isValidated) {
			alert(validationMessage);
		}

		return isValidated;
	}
</script>
</head>


<body class="bg-light">

	<div class="container pills-header">
		<div class="row">
			<div class="col-sm" style="padding-right: 10%;">
				<img class="d-block mx-auto mb-4 rbs-logo" src="asset/rbs.svg" alt="">
			</div>
			<div class="col-sm">
				<ul class="nav nav-pills link-piils">
					<li class="nav-item"><a href="#" class="nav-link active"
						aria-current="page">Attestation</a></li>
					<li class="nav-item"><a href="#"
						onClick="pageRedirect('/admin/login')" class="nav-link">Admin</a></li>
					<li class="nav-item"><a href="#"
						onClick="pageRedirect('/user/validation')" class="nav-link">User Validation</a></li>
				</ul>
			</div>
		</div>
	</div>


	<div class="container">
		<div class="py-3 text-center">
			<h2>Bitbucket Attestation Form</h2>
		</div>
		<main>

			<div class="col-md-7 col-lg-10" style="padding-left: 15%;">

				<form class="needs-validation" id="attestation" novalidate>
					<div class="row g-3">

						<div class="col-sm-12">
							<label for="empId" class="form-label">RBS Id* </label> 
							<input type="text" class="form-control" id="empId" name="empId"
								size="20" value="" placeholder="RBS RACF id" required>
						</div>

						<div class="col-12">
							<label for="email" class="form-label">Email* </label> 
							<input type="email" class="form-control" id="email" name="email"
								size="100" placeholder="you@rbs.com">
						</div>
						
						<div class="col-sm-12">
							<label for="project" class="form-label">Project*</label> 
							<input type="text" class="form-control" id="project" name="project"
								size="200" placeholder="Project Name" list="project_list" 
								onkeyup="getProjectList(this.value);" onblur="updateRepositoryUrl(document.getElementById('project').value)" required>
							<datalist id="project_list"></datalist>
						</div>
						
						<div class="col-sm-12">
							<label for="repositoryUrl" class="form-label">Repository URL* </label>
							<input type="text" class="form-control" id="repositoryUrl"
								name="repositoryUrl" size="200" value=""
								placeholder="Bitbucket Repository url" disabled required>
						</div>

						<input type="text" id="projectId" name="projectId" value=""
							size="8" hidden="true">

						<div class="col-12">
							<label for="agreement" class="form-label">Attestation Note </label>
							<textarea class="form-control" id="agreement" name="agreement"
								rows="10" cols="75" disabled>At w3schools.com you will learn how to make a website. They offer free tutorials in all web development technologies.
							</textarea>
						</div>

						<div class="col-12">
							<input type="checkbox" id="confirmed" name="confirmed" value=true required>
						    <label for="confirmed" class="form-label">I agree*</label>
						</div>
					</div>

					<hr class="my-4">

					<button class="w-100 btn btn-primary btn-lg" type="button"
						onclick="submitAttestation()">Submit Attestation</button>
				</form>
			</div>
		</main>

		<footer class="my-5 pt-5 text-muted text-center text-small">
			<p class="mb-1">&copy; 2021â€“2022 | RBS</p>
		</footer>
	</div>
</body>
</html>